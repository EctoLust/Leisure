PrefabFiles =
{
   "toys",
   "fuckbar",
   "dropedclothing",
   "stockings",
   "stockingschest",
   "lube",
   "towel",
   "shadowpuddle",
   "cumfx",
   "cumnew",
   "cumfloor",
   "lewdlovefx",
   "anticumpen",
   "boobspen",
   "clearpen",
   "strapon",
   "lustbook_item",
   --"lewd_mindcontroller",
   "censor",
   "stickysalve",
   "buttplug",
   "sciencewife",
   "sextalker",
   "plugtails",
   "libidopill",
   "antilibidopill",
   "whip_rope",
   "whip_kinki",
   "chaintits",
   "shadowgoop",
   "plantjuice",
   "lewddisguisekit",
   -- Characters
   "wormla",
   "wormla_none",
   "wormla_vine",
   "wormla_book",
   "wormla_whip",
}

Assets = 
{
	
	Asset("ANIM", "anim/blowjob.zip"),
	Asset("ANIM", "anim/sex.zip"),
	Asset("ANIM", "anim/monstersfuck.zip"),
	Asset("ANIM", "anim/takeoffclothing.zip"),
	Asset("ANIM", "anim/player_progressbar_small.zip"),
	Asset("ANIM", "anim/charlie_queen.zip"),
	Asset("ANIM", "anim/cookiecutter_build_rename.zip"),
	Asset("ANIM", "anim/pigman_fap.zip"),
	Asset("ANIM", "anim/spiderslut_sex.zip"),
	Asset("ANIM", "anim/fapanims.zip"),
	Asset("ANIM", "anim/disguiseuidoll.zip"),
	
	Asset("ANIM", "anim/cumnew.zip"),
	Asset("ANIM", "anim/cumanim.zip"),
	
	Asset("ANIM", "anim/shadowrape.zip"),
	
	Asset("ANIM", "anim/lustbook_item.zip"),
	
	Asset("ANIM", "anim/spiderslut.zip"),
	Asset("ANIM", "anim/stockingsbird.zip"),
	
	
	Asset("ANIM", "anim/nightmare1_alpha.zip"),
	Asset("ANIM", "anim/nightmare2_alpha.zip"),
	
	Asset("ANIM", "anim/pigman_torso_dick.zip"),
	Asset("ANIM", "anim/pigman_torso_dick_dark.zip"),
	Asset("ANIM", "anim/merm_torso_dick.zip"),
	
	Asset("ANIM", "anim/chaintits.zip"),
	
	
	--Naked builds
	Asset("ANIM", "anim/wendy_nude.zip"),
	Asset("ANIM", "anim/willow_nude.zip"),
	Asset("ANIM", "anim/large_nude.zip"),
	Asset("ANIM", "anim/small_nude.zip"),
	Asset("ANIM", "anim/male_nude.zip"),
	Asset("ANIM", "anim/male_nude_brown.zip"),
	Asset("ANIM", "anim/male_nude_gray.zip"),
	Asset("ANIM", "anim/wormla_nude.zip"),
	Asset("ANIM", "anim/wanda_nude.zip"),
	
	-- Ui
	Asset("ANIM", "anim/CharlieUi.zip"),
	Asset("ANIM", "anim/lube_bage.zip"),
	Asset("ANIM", "anim/status_sticky.zip"),
	Asset("ANIM", "anim/status_libido.zip"),
	
	--Dicks	
	Asset("ANIM", "anim/white_dick.zip"),
	Asset("ANIM", "anim/big_dick.zip"),
	Asset("ANIM", "anim/dildo_dick.zip"),
	Asset("ANIM", "anim/strapon_dick.zip"),
	Asset("ANIM", "anim/webber_dick.zip"),
	Asset("ANIM", "anim/webber_dick_white.zip"),
	Asset("ANIM", "anim/webber_dick_brown.zip"),
	Asset("ANIM", "anim/wormla_dick.zip"),
	
	Asset("ANIM", "anim/wortox_dick.zip"),
	Asset("ANIM", "anim/wx78_dick.zip"),
	Asset("ANIM", "anim/walter_dick.zip"),
	Asset("ANIM", "anim/warly_dick.zip"),
	Asset("ANIM", "anim/censor_dick.zip"),
	--Mobs Dicks
	Asset("ANIM", "anim/pig_dick.zip"),
	Asset("ANIM", "anim/merm_dick.zip"),
	Asset("ANIM", "anim/bunny_dick.zip"),
    Asset("ANIM", "anim/rocket_dick.zip"),	
	--Tails
	Asset("ANIM", "anim/plug_foxtail.zip"),	
	
	---Inv pics
	Asset("IMAGE", "images/inventoryimages/inv_spider.tex"),
	Asset("ATLAS", "images/inventoryimages/inv_spider.xml"),
	Asset("IMAGE", "images/inventoryimages/anticumpen.tex"),
	Asset("ATLAS", "images/inventoryimages/anticumpen.xml"),
	Asset("IMAGE", "images/inventoryimages/sciencewife.tex"),
	Asset("ATLAS", "images/inventoryimages/sciencewife.xml"),	
	
	
	Asset("IMAGE", "images/ui_anticum.tex"),
	Asset("ATLAS", "images/ui_anticum.xml"),
	Asset("IMAGE", "images/ui_boobs.tex"),
	Asset("ATLAS", "images/ui_boobs.xml"),
	Asset("IMAGE", "images/ui_dildo.tex"),
	Asset("ATLAS", "images/ui_dildo.xml"),
	Asset("IMAGE", "images/sex_tab.tex"),
	Asset("ATLAS", "images/sex_tab.xml"),
	Asset("IMAGE", "images/bookincum.tex"),
	Asset("ATLAS", "images/bookincum.xml"),

    -- Wormla
    Asset( "IMAGE", "images/saveslot_portraits/wormla.tex" ),
    Asset( "ATLAS", "images/saveslot_portraits/wormla.xml" ),

    Asset( "IMAGE", "images/selectscreen_portraits/wormla.tex" ),
    Asset( "ATLAS", "images/selectscreen_portraits/wormla.xml" ),
	
    Asset( "IMAGE", "images/selectscreen_portraits/wormla_silho.tex" ),
    Asset( "ATLAS", "images/selectscreen_portraits/wormla_silho.xml" ),

    Asset( "IMAGE", "bigportraits/wormla.tex" ),
    Asset( "ATLAS", "bigportraits/wormla.xml" ),
	
	Asset( "IMAGE", "images/map_icons/wormla.tex" ),
	Asset( "ATLAS", "images/map_icons/wormla.xml" ),
	
	Asset( "IMAGE", "images/avatars/avatar_wormla.tex" ),
    Asset( "ATLAS", "images/avatars/avatar_wormla.xml" ),
	
	Asset( "IMAGE", "images/avatars/avatar_ghost_wormla.tex" ),
    Asset( "ATLAS", "images/avatars/avatar_ghost_wormla.xml" ),
	
	Asset( "IMAGE", "images/avatars/self_inspect_wormla.tex" ),
    Asset( "ATLAS", "images/avatars/self_inspect_wormla.xml" ),
	
	Asset( "IMAGE", "images/names_wormla.tex" ),
    Asset( "ATLAS", "images/names_wormla.xml" ),
	
	Asset( "IMAGE", "images/names_gold_wormla.tex" ),
    Asset( "ATLAS", "images/names_gold_wormla.xml" ),
	
	Asset( "ANIM", "anim/wormla.zip" ),
	Asset( "ANIM", "anim/ghost_wormla_build.zip" ),
	Asset("ANIM", "anim/cdman.zip"),
}

local require = GLOBAL.require
local STRINGS = GLOBAL.STRINGS
local TUNING = GLOBAL.TUNING
local State = GLOBAL.State
local Action = GLOBAL.Action
local ActionHandler = GLOBAL.ActionHandler
local TimeEvent = GLOBAL.TimeEvent
local EventHandler = GLOBAL.EventHandler
local ACTIONS = GLOBAL.ACTIONS
local FRAMES = GLOBAL.FRAMES

local VoteUtil = GLOBAL.require("voteutil")
local UserCommands = GLOBAL.require("usercommands")

-- Config data
TUNING.TUTORIAL_SKIP = GetModConfigData("tutorial_skip")
TUNING.SHADOWHANDS_SPAWN = GetModConfigData("shadow_spawn")
TUNING.MONSTERS_RAPE = GetModConfigData("monsters_rape")
TUNING.LUSTBOOK_ONSPAWN = GetModConfigData("lustbook")
TUNING.DILDO_RAIN_ENABLE = GetModConfigData("dildo_rain")
TUNING.NO_RAPE_DAMAGE = GetModConfigData("rape_no_damage")
TUNING.OLD_CUM_TYPE = 0

TUNING.TENT_USES = 100
modimport("lewd_strings.lua")
modimport("lewd_nethook.lua")
modimport("scripts/suckoff_action.lua") 
modimport("scripts/sex_action.lua")
modimport("scripts/play_action.lua")
modimport("scripts/tie_action.lua") 
modimport("scripts/puton_action.lua") 
modimport("scripts/lube_action.lua") 
modimport("scripts/simpleuse_action.lua") 
modimport("scripts/simpleread_action.lua") 
modimport("scripts/lustbook_action.lua") 
modimport("scripts/sg_player.lua") 
modimport("scripts/monsters_hooks.lua")
modimport("scripts/objects_hooks.lua")
modimport("lewd_containers.lua")
modimport("lewd_recipes.lua")
modimport("lewd_hud.lua")
modimport("lewd_bodysettings.lua")
modimport("lewd_chars.lua")
modimport("lewd_poses.lua")

local Inv = GLOBAL.getmetatable(GLOBAL.TheInventory).__index
local _CheckClientOwnership = Inv.CheckClientOwnership
Inv.CheckClientOwnership = function(self, id, ...)
	if not id then
	    return false
    end
    return _CheckClientOwnership(self, id, ...)
end

local DEGREES = GLOBAL.DEGREES

local function IsOnHud()
	local TheFrontEnd = GLOBAL.TheFrontEnd
	
	if not TheFrontEnd then 
		return false
	else
		if not TheFrontEnd.GetActiveScreen or not TheFrontEnd:GetActiveScreen() or not TheFrontEnd:GetActiveScreen().name or TheFrontEnd:GetActiveScreen().name ~= "HUD" then
			return false
		end
	end
	
	return true
end


local function GiveMeNearPosePlz(inst, dst, randomval)
    local savetruedst = dst
	if randomval then
       dst = math.random(15,dst)
	end
	
	local heading_angle = inst.Transform:GetRotation()

    local object_heading_angle = heading_angle + 90-45 + 90*math.random()

    if math.random()<0.5 then
        object_heading_angle = heading_angle - 90+45 - 90*math.random()
    end

    local dir_object = GLOBAL.Vector3(math.cos(object_heading_angle*DEGREES),0, math.sin(object_heading_angle*DEGREES))
    local x,y,z = inst.Transform:GetWorldPosition()
    local dist = dst + 0.2*dst*math.random()
    local posedata = {x - dist*dir_object.x, 0, z - dist*dir_object.z}
	return posedata
end

function GetGenderStrings(charactername)
    for gender,characters in pairs(GLOBAL.CHARACTER_GENDERS) do
        if table.contains(characters, charactername) then
            return gender
        end
    end
    return "DEFAULT"
end

local function RetrunPhisics(inst)
    GLOBAL.MakeCharacterPhysics(inst, 75, .5)
	if inst.bj_oldxy then
	    inst.Transform:SetPosition(inst.bj_oldxy[1],inst.bj_oldxy[2],inst.bj_oldxy[3])
	end
end

local function StopBj(inst)
	inst.components.health:SetInvincible(false)
    inst.AnimState:SetLayer(GLOBAL.LAYER_WORLD)
	inst.components.cumattachable:ChangeLayer(GLOBAL.LAYER_WORLD)
    inst.AnimState:SetSortOrder(0)
	inst.Transform:SetFourFaced(inst)    
	if inst.poseswap == true then
	    inst.poseswap = nil
		return
	end
	inst.poseinverted = nil
    RetrunPhisics(inst)
	if inst.talk_save then
	    inst.components.talker.offset = inst.talk_save
	end
	inst.components.talker.symbol = nil
	if inst.fuckbar then
	     inst.fuckbar:Remove()
	end
    if inst.partner then
        inst:DoTaskInTime(0.1, 
		function()
		    if inst.partner and inst.partner.sg:HasStateTag("suck") then
		        inst.partner.sg:GoToState("idle")
		    end
			inst.partner = nil 
		end)
	end
end
--ThePlayer.partner.components.health:SetVal(0)
local function StopMonsterFuck(inst)
    inst.AnimState:SetLayer(GLOBAL.LAYER_WORLD)
	inst.components.cumattachable:ChangeLayer(GLOBAL.LAYER_WORLD)
    inst.AnimState:SetSortOrder(0)
	inst.Transform:SetFourFaced(inst)    
	if inst.poseswap == true then
	    inst.poseswap = nil
		if inst.partner and inst.partner:HasTag("HavingSex") then
            inst.partner:PushEvent("stopmonsterfuck")
		end
		return
	end
	RetrunPhisics(inst)
	if inst.fuckbar then
	     inst.fuckbar:Remove()
	end
	if inst.whatneedtoclear then
	    inst.AnimState:ClearOverrideBuild(inst.whatneedtoclear)
	end
	inst.waitabit = 7
	inst.plugprotection = 0
	inst.AnimState:ClearOverrideSymbol("leg_s")
	inst.AnimState:ClearOverrideSymbol("face_s")
	inst.AnimState:ClearOverrideSymbol("body")
    if not inst:IsHUDVisible() then
        inst:ShowHUD(true)
        --inst:SetCameraDistance(12)
    end
	inst.components.health:SetInvincible(false)
    inst.AnimState:SetLayer(GLOBAL.LAYER_WORLD)
	inst.components.cumattachable:ChangeLayer(GLOBAL.LAYER_WORLD)
    inst.AnimState:SetSortOrder(0)
	inst.Transform:SetFourFaced(inst)

	inst:DoTaskInTime(0.1, function()
	if inst.sg:HasStateTag("fuck") and not inst.sg:HasStateTag("dead") then
	    if inst:HasTag("FallAfterFuck") then
	        inst.sg:GoToState("knockback")
			inst:RemoveTag("FallAfterFuck")
		elseif inst:HasTag("WakeupOnFuckEnd") then
		    inst.sg:GoToState("wakeup")
			inst:RemoveTag("WakeupOnFuckEnd")
	    else
	        inst.sg:GoToState("idle")
	    end
	end --
	end)
    if inst.partner then
        inst:DoTaskInTime(0.1, 
		function()
		    if inst.partner and inst.partner:HasTag("HavingSex") then
                inst.partner:PushEvent("stopmonsterfuck")
		    end
			inst.partner = nil 
		end)
	end
end

local function StopFuck(inst)
    inst.AnimState:SetLayer(GLOBAL.LAYER_WORLD)
	inst.components.cumattachable:ChangeLayer(GLOBAL.LAYER_WORLD)
    inst.AnimState:SetSortOrder(0)
	inst.Transform:SetFourFaced(inst)    
	if inst.poseswap == true then
	    inst.poseswap = nil
		return
	end
	inst.poseinverted = nil
    GLOBAL.RemoveCensore(inst)
	GLOBAL.Censore(inst,0,0,"torso",1,0.2,0.5)
    GLOBAL.Censore(inst,0,-58,"torso",0.5,0.2,0.5)
	RetrunPhisics(inst)
	if inst.talk_save then
	    inst.components.talker.offset = inst.talk_save
	end
	inst.components.talker.symbol = nil
	if inst.fuckbar then
	     inst.fuckbar:Remove()
	end
    if inst.partner then
        inst:DoTaskInTime(0.1, 
		function()
		    if inst.partner and inst.partner.sg:HasStateTag("fuck") then
		        if not inst.partner:HasTag("ropped") then
				    inst.partner.sg:GoToState("idle")
					inst.partner.sg:GoToState("wakeup")
				else
				    inst.partner.sg:GoToState("idle")
		            inst.partner.sg:GoToState("wakeup")
				end
		    end
			inst.partner = nil 
		end)
	end
end

local function KillToy(inst)
	if inst.whatneedtoclear then
	    inst.AnimState:ClearOverrideBuild(inst.whatneedtoclear)
	end
	inst.AnimState:ClearOverrideSymbol("leg_s")
	inst.AnimState:ClearOverrideSymbol("face_s")
	inst.AnimState:ClearOverrideSymbol("body")
	if inst.toytokill then
	    if inst.toytokill and inst.toytokill.components.health then
		    local owner = inst.toytokill.components.inventoryitem:GetGrandOwner()
			if owner == inst then
			    inst.components.inventory:DropItem(inst.toytokill)
			    inst.toytokill.components.health:Kill()
			end
		end
	end
end

local function Cum_old(inst)
	inst.intim_orgasmsecondsleft = inst.intim_orgasmwait
	if inst.anticumday == 0 then
	for x = 1, inst.intim_orgasmcount, 1 do
	local decay = 0.3+x/7
    inst:DoTaskInTime(decay, function()
        local cumfx = "cumfx"
        if inst:HasTag("ROBOT") then
			cumfx = "sparks"
		end
		local fx = GLOBAL.SpawnPrefab(cumfx)
	    --fx.Transform:SetPosition(inst.Transform:GetWorldPosition())
		fx.entity:SetParent(inst.entity) 
        fx.entity:AddFollower()		
        fx.Follower:FollowSymbol(inst.GUID, "torso_pelvis", 0, 0, 0)	
		if x == inst.intim_orgasmcount then
	        local puddle = GLOBAL.SpawnPrefab("ice_puddle")
			local size = 0.7
	        puddle.Transform:SetPosition(inst.Transform:GetWorldPosition())
			puddle.Transform:SetScale(size,size,size)
			if inst:HasTag("ROBOT") then
				puddle.AnimState:SetMultColour(0, 0, 0, 1)
				if inst.partner and inst.partner:HasTag("player") then
				    inst.partner.sg:GoToState("electrocute")
				end
			else			
	            puddle.AnimState:SetMultColour(1, 1, 1, 1)
			end			
			puddle:DoTaskInTime(9, GLOBAL.ErodeAway)
			inst.components.moisture:DoDelta(5)
		end
	end)
	end
	end
end

local function Cum(inst)
	inst.intim_orgasmsecondsleft = inst.intim_orgasmwait
	if inst.anticumday == 0 then
	for x = 1, inst.intim_orgasmcount, 1 do
	local decay = 0.3+x/7
    inst:DoTaskInTime(decay, function()
        local cumfx = "cumfx"
        if inst:HasTag("ROBOT") then
			cumfx = "sparks"
		end
		local fx = GLOBAL.SpawnPrefab(cumfx)
		fx.entity:SetParent(inst.entity) 
        fx.entity:AddFollower()		
        fx.Follower:FollowSymbol(inst.GUID, "torso_pelvis", 0, 0, 0)	
		if x == inst.intim_orgasmcount then
		    for x2 = 1, 3, 1 do
	            local cum = GLOBAL.SpawnPrefab("cumfloor")
				
				if not inst.components.naked:IsHasDick()then
	                local num = math.random(7)
	                cum.AnimState:PlayAnimation(num.."_front")				    
				end
				
				if inst:HasTag("ROBOT") then
				    cum.AnimState:SetMultColour(0, 0, 0, 1)
				end
				
				if inst.partner and inst.partner.components.cumattachable and (inst.sg:HasStateTag("cancumonface") or inst.sg:HasStateTag("cancumonbody")) then
				    local fem = false
					local rob = inst:HasTag("ROBOT")
					local symb = "face"
					
					if not inst.components.naked:IsHasDick() then
					    fem = true
					end				
					if inst.sg:HasStateTag("cancumonbody") then
					    symb = "torso"
				    elseif inst.sg:HasStateTag("cancumonface") then
					    symb = "face"
					end
					
					if not inst.partner.components.cumattachable:HaveCum(symb) then
					    inst.partner.components.cumattachable:AddCum(fem, rob, symb)
					end
				end
				
			    local speed = math.random() * 3 + 2
				local pos = inst:GetPosition()
	            cum.Transform:SetPosition(pos.x,0.3,pos.z)
            
                local angle = math.random(360)
                cum.Physics:SetVel(speed * math.cos(angle), math.random() * 2 + 8, speed * math.sin(angle))			
			end
			inst.components.moisture:DoDelta(5)
		end
	end)
	end
	end
end

local function OrgasmicCheck(inst) 
	if inst.sg:HasStateTag("fuck") and inst.partner ~= nil and inst.partner:HasTag("player") then
        if inst.components.excited and inst.components.excited.libido > 0 then
		    if inst.components.excited.libido > 65 then
				inst.components.sanity:DoDelta(1)
				if inst.prefab == "wormla" then	
				    inst.components.health:DoDelta(1)
					inst.partner.components.health:DoDelta(1)
				end
		    end							
			inst.components.excited.libido = inst.components.excited.libido-1
        end				 
    end	
	
	if inst.waitabit then
	    inst.waitabit = inst.waitabit-1
		if inst.waitabit <= 0 then
		    inst.waitabit = nil
		end
	end
	if inst.plugprotection then	    
		if inst.plugprotection > 0 then
		    inst.plugprotection = inst.plugprotection-1
		end
	end

    if not inst.AnimState:IsCurrentAnimation("emote_pre_sit2") and not inst.AnimState:IsCurrentAnimation("body_pre") and inst.sg:HasStateTag("cancum")  then
	    if inst.intim_orgasmsecondsleft > 0 then
	        inst.intim_orgasmsecondsleft = inst.intim_orgasmsecondsleft-1
	    end
	    if inst.intim_orgasmsecondsleft == 0 then
            inst:PushEvent("cum")
	    end		
		
	    if inst.intim_orgasmsecondsleft == 2 then
	        if math.random() < 0.65 then
		        GLOBAL.SayRandomSexQuote(inst,GLOBAL.STRINGS.GONNA_CUM)
		    end
	    end
	end
end

local function GoAway(inst)
    inst.sg:GoToState("idle")
	local fx = GLOBAL.SpawnPrefab("shadow_despawn")
	fx.Transform:SetPosition(inst.Transform:GetWorldPosition())
	inst:DoPeriodicTask(0.01, function()
	inst:Remove()
	end)
end

local function SummonGirl(inst, name, skin)
    local girl = GLOBAL.SpawnPrefab(name)
	local posedata = GiveMeNearPosePlz(inst, 3, false)
	
	girl.Transform:SetPosition(posedata[1], posedata[2], posedata[3])
	inst.summoned_girl = girl
	
    local fx = GLOBAL.SpawnPrefab("shadow_despawn")
	fx.Transform:SetPosition(girl.Transform:GetWorldPosition())
	
    local fx = GLOBAL.SpawnPrefab("shadow_shield3")
	fx.Transform:SetPosition(girl.Transform:GetWorldPosition())	
	
	girl:AddTag("dummy")
	girl:AddTag("playerghost")
	girl.components.health:SetInvincible(true)
	girl.components.sanity.IsEnlightened = function() 
	    return true 
	end
	
	local base_item = base_item or (girl.prefab .."_none")
	
	if skin ~= nil then
	    base_item = skin
	end
	
	--load skin 
	local base_build = girl.prefab
	
	local skindata = GLOBAL.GetSkinData(base_item)
	local skindata_skins = skindata.skins
	if skindata_skins ~= nil then
		base_build = skindata_skins["normal_skin"]
	end
	GLOBAL.SetSkinsOnAnim(girl.AnimState, girl.prefab, base_build, {}, "normal_skin")
end

AddModRPCHandler("LEWD", "CALL", function(inst, wtf, name, skin)
    if inst ~= nil and not inst:HasTag("playerghost") then 
	    -- Despawn in any case.
		if name ~= "" and inst.summoned_girl ~= nil then
		    GoAway(inst.summoned_girl)
		    inst.summoned_girl = nil
	    end	
		-- Spawning if is not unsummoning.
		if name ~= "" and name ~= "unsummon"then
		    SummonGirl(inst, name, skin)
		end		
		inst.sg:GoToState("idle")
	end
end)

-- local function MakeCharlie()
	-- local OhYesRightHere = nil
	-- for k,ent in pairs(GLOBAL.Ents) do
	    -- if ent.prefab == "firepit" then
		    -- local player = GLOBAL.FindEntity(ent, 14, function(item) return item:HasTag("player") end, nil, { "" })  	
            -- if player ~= nil then
				-- OhYesRightHere = ent
				-- break -- burn in hell "break"
			-- end
		-- end
    -- end	
	-- if OhYesRightHere then
        -- local inst = GLOBAL.SpawnPrefab("willow")
		-- local posedata = GiveMeNearPosePlz(OhYesRightHere, 3, false)
		-- inst.Transform:SetPosition(posedata[1], posedata[2], posedata[3])
        -- local fx = GLOBAL.SpawnPrefab("shadow_despawn")
	    -- fx.Transform:SetPosition(inst.Transform:GetWorldPosition())
        -- local fx = GLOBAL.SpawnPrefab("shadow_shield3")
	    -- fx.Transform:SetPosition(inst.Transform:GetWorldPosition())
        -- inst.AnimState:SetBuild("charlie_queen")
	    -- inst.components.health:SetInvincible(true)
	    -- inst:AddTag("CHARLIEBITCH")
		-- inst:AddComponent("named")
		-- inst.components.named:SetName("Charile")
        -- if math.random()<0.5 then
		    -- inst:AddTag("sexable")
			-- inst:RemoveComponent("bj")
		-- else
		    -- inst:AddTag("bjable")
			-- inst:RemoveComponent("sex")
		-- end
		-- if math.random()<0.1 then
		    -- inst:RemoveComponent("sex")
			-- inst:RemoveComponent("bj")
			-- inst:RemoveTag("sexable")
			-- inst:RemoveTag("bjable")
			-- inst.sg:GoToState("fap_state")
			-- inst:AddTag("NOCLICK")
		-- end
	    -- inst:WatchWorldState("cycles", GoAway)
	-- end
-- end

-- AddPrefabPostInit("world", function(inst)
    -- if GLOBAL.TheWorld.ismastersim then
	    -- inst.charlieintheworld = false
		-- inst:DoPeriodicTask(1, function()
		    -- if inst.charlieintheworld == false and GLOBAL.TheWorld.state.phase == "night" then
                -- inst.charlieintheworld = true	
				-- print("Now night, trying spawn charlie")
				-- MakeCharlie()
			-- end
		-- end)
		-- inst:WatchWorldState("cycles", function()
		    -- inst.charlieintheworld = false
		-- end)
	-- end
-- end)

local function ClientOpenNudeMenu(inst)
    if GLOBAL.TheCamera then
	    GLOBAL.TheCamera:SetDistance(9)
	end
	if GLOBAL.ThePlayer then
	    local NakedScreen = GLOBAL.require "screens/nakedscreen"
	    local openscreen = NakedScreen(self)
	    GLOBAL.TheFrontEnd:PushScreen(openscreen)
	end
end

local function ClientOpenPoseMenu(inst)
    if GLOBAL.TheCamera then
	    GLOBAL.TheCamera:SetDistance(9)
	end
	if GLOBAL.ThePlayer then
	    local SexScreen = GLOBAL.require "screens/sexposesscreen"
	    local openscreen = SexScreen(self)
	    GLOBAL.TheFrontEnd:PushScreen(openscreen)
	end
end

local function NudeReset(inst)
    if inst.components.naked then
	    inst:DoTaskInTime(0, function()
	    inst.components.naked:DoReset()
		end)
	end
end

local function UpdateNude(inst)
    if inst.components.naked then
	    inst:DoTaskInTime(0, function()
	    inst.components.naked:Fixup()
		end)
	end
end

local function MakeShadowPuddlesAround(inst)
    local tospawn = 1
	if #GLOBAL.AllPlayers > 1 then
	    tospawn = 3
	end
    if GLOBAL.TheWorld.state.phase == "night" then
        for x = 1,tospawn,1 do
		    local shadow = GLOBAL.SpawnPrefab("shadowpuddle")
		    local posedata = GiveMeNearPosePlz(inst, 20, true)
		    shadow.Transform:SetPosition(posedata[1], posedata[2], posedata[3])	
		end
	end
end

local function Moans(inst)
	if inst.partner and inst.partner:HasTag("player") and inst.sextalker == nil then
	    if inst.components.excited then
		    inst.components.excited.daysnosex = 0
		end
	    if math.random() < 0.45 then		    
			if math.random() < 0.67 then
			    GLOBAL.SayRandomSexQuote(inst,GLOBAL.STRINGS.SEX_MOANS)
			else
			    local fuckmode = inst.components.naked:CheckSexGender()	
				if fuckmode == "partner" or fuckmode == "gay" then
				    GLOBAL.SayRandomSexQuote(inst,GLOBAL.STRINGS.PRAISE_FOR_BOY)
				else
				    GLOBAL.SayRandomSexQuote(inst,GLOBAL.STRINGS.PRAISE_FOR_GIRL_SEX)
				end
			end
		end
	end
end


local function MyPlayerMain(inst)
    inst.intim_gender = GetGenderStrings(inst.prefab) 
	inst:AddTag(GetGenderStrings(inst.prefab)) 
	inst:AddTag("bjable")
	inst:AddTag("tieable")
	inst.AnimState:OverrideSymbol("sextalker", "sextalker", "sextalker")
	
    GLOBAL.TheInput:AddKeyDownHandler(GLOBAL.KEY_N, function()
        if IsOnHud() then	        
			ClientOpenNudeMenu(inst)
	    end
    end)
    GLOBAL.TheInput:AddKeyDownHandler(GLOBAL.KEY_Z, function()
        if IsOnHud() then	        
            if GLOBAL.TheCamera then
	            GLOBAL.TheCamera:SetDistance(9)
	        end
	    end
    end)
    GLOBAL.TheInput:AddKeyDownHandler(GLOBAL.KEY_P, function()
        if IsOnHud() then	        
            if GLOBAL.TheCamera then
	            ClientOpenPoseMenu(inst)
	        end
	    end
    end)
	GLOBAL.TheInput:AddKeyUpHandler(GLOBAL.KEY_SPACE, function()
		GLOBAL.SendModRPCToServer(MOD_RPC["LEWD"]["AVOID"], inst)
	end)
	
	-- if inst.replica.combat then    
		-- local OldCanAtk = inst.replica.combat.CanBeAttacked -- Saving original function 
		-- local OldValidTar = inst.replica.combat.IsValidTarget -- Saving original function 
		
		-- inst.replica.combat.CanBeAttacked = function(self, attacker)
            -- local inst = self.inst
			-- local weapon = attacker.replica.combat:GetWeapon()
			-- if inst:HasTag("player") and attacker ~= nil and attacker:HasTag("player") and weapon ~= nil and weapon:HasTag("nohurt") then
			    -- return true
			-- else
			    -- return OldCanAtk(self,attacker) -- Not our case return default result.
			-- end
		-- end
		-- inst.replica.combat.IsValidTarget = function(self, target)	    
			-- local inst = self.inst
			-- local weapon = inst.replica.combat:GetWeapon()
			-- if inst:HasTag("player") and target ~= nil and target:HasTag("player") and weapon ~= nil and weapon:HasTag("nohurt") then
			    -- return true
			-- else
			    -- return OldValidTar(self,target) -- Not our case return default result.
			-- end
		-- end
	-- end
	
    if not GLOBAL.TheWorld.ismastersim then
        return inst
    end
	
	inst:AddComponent("bj")
	inst:AddComponent("sex")
	inst:AddComponent("lootdropper")
	inst:AddComponent("naked")
	inst:AddComponent("excited")
	inst:AddComponent("cumattachable")
	--inst.components.cumattachable:AddCum()
	--inst:DoPeriodicTask(1.7, OnSuck) 
	inst.intim_gender = GetGenderStrings(inst.prefab) 
	--inst.AnimState:OverrideSymbol("bandagerope", "sex_ropes", "bandagerope")
	inst.lube = 0
	inst.stickysalve = 0
	inst.anticumday = 0
	inst.boobsresize = 0
	inst.virginity = true
	inst.firstsexwith = ""
	inst.aids = false
	
	inst:WatchWorldState("cycles", function()
		if inst.anticumday > 0 then
		    inst.anticumday = inst.anticumday-1
        end	
		if inst.boobsresize > 0 then
		    inst.boobsresize = inst.boobsresize-1
			if inst.boobsresize == 0 then
			    inst.components.naked:SetDefaultTits()
			end
        end		
	end)

	if inst.intim_gender == "MALE" then
		inst.intim_orgasmwait = 12 -- Секунд до оргазма
		inst.intim_orgasmcount = 1 -- Извержения 
		inst.intim_orgasmsecondsleft = inst.intim_orgasmwait -- Текущие значение
	elseif inst.intim_gender == "FEMALE" then
	    inst.intim_orgasmwait = 17
		inst.intim_orgasmcount = 3 -- У девушек несколько раз будет эукляция
		inst.intim_orgasmsecondsleft = inst.intim_orgasmwait
	elseif inst.intim_gender == "ROBOT" then
	    inst.intim_orgasmwait = 20
		inst.intim_orgasmcount = 5
		inst.intim_orgasmsecondsleft = inst.intim_orgasmwait
	end
	inst:DoPeriodicTask(1, OrgasmicCheck) 
	
	
	if TUNING.SHADOWHANDS_SPAWN == 1 then
	    inst:DoPeriodicTask(50, MakeShadowPuddlesAround)
	end
	
	inst:DoPeriodicTask(2.5, Moans)
	
	
	inst:DoPeriodicTask(0.7, function()
	     
		 if inst.prefab == "winona" and inst.partner and inst.partner.prefab == "wx78" then
		     inst.components.burnable:Ignite(true, inst)
		 end
		 
		 if inst.prefab == "wx78" and inst.partner and inst.partner.prefab == "winona" then
		     inst.components.burnable:Ignite(true, inst)
		 end
		 
		 if inst.prefab == "waxwell" and inst.partner and inst.partner.prefab == "wendy" then
		     inst.components.burnable:Ignite(true, inst)
			 inst.components.health:DoDelta(-70)
		 end
		 
		 if not inst.AnimState:IsCurrentAnimation("emote_pre_sit2") and not inst.AnimState:IsCurrentAnimation("body_pre") and inst.sg:HasStateTag("cancum") and not inst.sg:HasStateTag("noslic") then
		     if inst:HasTag("ROBOT") then
			     inst.SoundEmitter:PlaySound("dontstarve/characters/wx78/spark", nil, 0.23)
			 else
			     inst.SoundEmitter:PlaySound("dontstarve/tentacle/tentacle_splat", nil, 0.23)
			 end
		 end
		 if inst.sg:HasStateTag("waking") then
		     inst:RemoveTag("ropped")
		 end
		 if not inst:HasTag("CHARLIEBITCH") then
	         if inst.sg:HasStateTag("knockout") or inst.sg:HasStateTag("bedroll") then
		         if inst.sg:HasStateTag("knockout") then
			         inst:AddTag("sexable")
			     else
			         inst:AddTag("flipfuckable")
			     end
			     inst:RemoveTag("bjable")
		     else
			     inst:RemoveTag("sexable")
			     inst:RemoveTag("flipfuckable")
			     inst:AddTag("bjable")
		     end
		 end
	end)
	inst:DoPeriodicTask(3, function() -- Проверка смазки
	     if inst.sg:HasStateTag("fuck")then
		     if inst.lube > 0  then
			     inst.lube = inst.lube-1
			     if inst.components.health then
			         inst.components.health:DoDelta(1)
                 end
                 if inst.partner and inst.components.health then
			         inst.partner.components.health:DoDelta(1)
                 end
			 end
		 end
	     if inst.sg:HasStateTag("fap") or inst.sg:HasStateTag("friendlyfuck") then
             if inst.components.excited and inst.components.excited.libido > 0 then		     
				 if inst.components.excited.libido > 65 then
				     inst.components.sanity:DoDelta(1)
				     if inst.prefab == "wormla" then	
				         inst.components.health:DoDelta(1)
				     end
				 end		 
				 inst.components.excited.libido = inst.components.excited.libido-1
             end
		 end
	     if inst.partner and inst.partner:HasTag("plantfuck") and inst.prefab == "wormla" then
		     inst.components.sanity:DoDelta(1)
		 end	
	end)
	inst.lastseenSkinMode = nil
	inst:DoPeriodicTask(0, function()
	     if inst.sg:HasStateTag("fuck") and inst.partner and inst.virginity == true then
             inst.virginity = false
			 local fuckername = inst.partner:GetDisplayName() or "Unknown"
			 if inst.partner:HasTag("pig") then
			     fuckername = fuckername.." (Pigman)"
			 end
             inst.firstsexwith = fuckername			 
             GLOBAL.TheNet:Announce(inst:GetDisplayName().." lost virginity with "..fuckername)			 
		 end
		 if inst.lastseenSkinMode == nil and inst.components.skinner ~= nil and inst.components.skinner.skintype ~= nil then
		     inst.lastseenSkinMode = inst.components.skinner.skintype
		 end
		 if inst.lastseenSkinMode ~= nil then
		     if inst.lastseenSkinMode ~= inst.components.skinner.skintype then
			     inst.lastseenSkinMode = inst.components.skinner.skintype
				 print("Skin mode updated, restarting nudes")
				 UpdateNude(inst)
			 end
		 end
	end)
	inst:ListenForEvent("cum", Cum)
	inst:ListenForEvent("killtoy", KillToy)
	inst:ListenForEvent("stopbj", StopBj)
	inst:ListenForEvent("stopfuck", StopFuck)
	inst:ListenForEvent("stopmonsterfuck", StopMonsterFuck)
	inst:ListenForEvent("ms_closewardrobe", NudeReset)
	inst:ListenForEvent("onremove", function()
	    if inst.userid ~= nil and inst.userid ~= "" then
		    GLOBAL.ClientChangedDisguise(inst.userid, "", "MyPlayerMain:onremove")
			if inst == GLOBAL.ThePlayer then
			    GLOBAL.SetClientDisguise(inst.userid, "")
			end
		end
	end)


	inst.Old_S = inst.OnSave
	inst.Old_L = inst.OnLoad
    inst.OnSave = function(inst, data) 
	    if data then
            if inst.lube and inst.lube > 0 then
		        data.lube = inst.lube
		    end
			if inst.virginity == false then
			    data.virginity = inst.virginity
				data.firstsexwith = inst.firstsexwith
			end
			if inst.anticumday and inst.anticumday > 0 then
			   data.anticumday = inst.anticumday
			end
			if inst.boobsresize and inst.boobsresize > 0 then
			   data.boobsresize = inst.boobsresize
			end
			if inst.stickysalve and inst.stickysalve > 0 then
			    data.stickysalve = inst.stickysalve
			end
			if inst.bodyconfigstate ~= nil then
			    data.bodyconfigstate = inst.bodyconfigstate
			end
	    end
	    if inst.Old_S ~= nil then
	        return inst.Old_S(inst, data)
	    end
	end
    inst.OnLoad = function(inst, data, newents) 
	    if data then
            if data.lube then
		        inst.lube = data.lube
		    end
			if data.virginity == false then
			    inst.virginity = data.virginity
				inst.firstsexwith = data.firstsexwith
				inst.firstfuckername_client:set(inst.firstsexwith)
			end
			if data.anticumday then
			    inst.anticumday = data.anticumday
			end
			if data.boobsresize then
			    inst.boobsresize = data.boobsresize
			end
			if data.stickysalve then
			    inst.stickysalve = data.stickysalve
			end
			if data.bodyconfigstate then
			    inst.bodyconfigstate = data.bodyconfigstate
				if inst.bodyconfigstate == "inmenu" then
				    inst:DoTaskInTime(0, function()
					    GLOBAL.TheWorld:PushEvent("ms_playerdespawnanddelete", inst)
					end)
				end
			end
	    end
	    if inst.Old_L ~= nil then
	        return inst.Old_L(inst, data)
	    end
	end
end

AddPlayerPostInit(MyPlayerMain) -- Хук на персонажа


local function MakeTinyChest(inst)
    local posedata = GiveMeNearPosePlz(inst, 1, false)
	local tiny = GLOBAL.SpawnPrefab("stockingschest")
	tiny.Transform:SetPosition(posedata[1], posedata[2], posedata[3])
	tiny:PushEvent("onbuilt")
end

AddPrefabPostInit("wardrobe",function(inst)
    if not GLOBAL.TheWorld.ismastersim then
        return inst
    end
	inst:ListenForEvent("onbuilt", MakeTinyChest)
end)

--clearpen

--boobspen

GLOBAL.SpawnEffect = function(inst, player)
    if player then
        player.AnimState:SetMultColour(0, 0, 0, 1)
        player:Hide()
        player.components.playercontroller:Enable(false)
        player:DoTaskInTime(12 * GLOBAL.FRAMES, function(inst) 
        player:Show()
        player:DoTaskInTime(60 * GLOBAL.FRAMES, function(inst)
        inst.components.colourtweener:StartTween({ 1, 1, 1, 1 }, 14 * GLOBAL.FRAMES, function(inst)
            player.components.playercontroller:Enable(true)
			player.components.health:SetInvincible(false)
        end)end)end)
        if not inst.sg:HasStateTag("construction") then
            inst.sg:GoToState("spawn_pre")
        end
	end
end

local function HookPortal(inst)
    if not GLOBAL.TheWorld.ismastersim then
        return inst
    end
	
	GLOBAL.TheWorld.spawn_portal = inst
 
	inst:ListenForEvent("ms_newplayercharacterspawned", function(world, data) 
        if data and data.player then
            data.player:DoTaskInTime(0, function(inst)
                data.player.bodyconfigstate = "inmenu"
				data.player:Hide()
				data.player.components.playercontroller:Enable(false)
				data.player.components.health:SetInvincible(true)
				data.player.lewdstart_client:push()
            end)
        end
    end, GLOBAL.TheWorld)
end

AddPrefabPostInit("multiplayer_portal", HookPortal)
AddPrefabPostInit("multiplayer_portal_moonrock_constr", HookPortal)
AddPrefabPostInit("multiplayer_portal_moonrock", HookPortal)

local function onfinished(inst)
    inst:Remove()
end

AddPrefabPostInit("trinket_8", function(inst) 

    inst:AddTag("plug")  

    if not GLOBAL.TheWorld.ismastersim then
        return inst
    end
	
	inst:RemoveComponent("stackable")

    inst:AddComponent("finiteuses")
    inst.components.finiteuses:SetOnFinished(onfinished)
    inst.components.finiteuses:SetMaxUses(5)
    inst.components.finiteuses:SetUses(5)
	
    inst:AddComponent("equippable")
    inst.components.equippable.equipslot = GLOBAL.EQUIPSLOTS.BODY	
	
end)

AddPrefabPostInit("forest", function(inst) 
    GLOBAL.RegisterDisguiseNetHook(inst)
    if not GLOBAL.TheWorld.ismastersim then
        return inst
    end
	if TUNING.DILDO_RAIN_ENABLE == 1 then
	    inst:AddComponent("dildorain")
	end
end)

AddPrefabPostInit("goldnugget", function(inst) 
    if not GLOBAL.TheWorld.ismastersim then
        return inst
    end
	inst:DoTaskInTime(0, function(inst)
	    if inst.components.inventoryitem.owner == nil then
	        if math.random()<0.05 then
		       local newgold = GLOBAL.SpawnPrefab("dildo_gold")
	           newgold.Transform:SetPosition(inst.Transform:GetWorldPosition())			    
			end
	    end
	end)
end)

GLOBAL.SetSharedLootTable('hound_fire_new',
{
    {'buttplug_red', 0.23},
	{'monstermeat', 1.0},
    {'houndstooth', 1.0},
    {'houndfire',   1.0},
    {'houndfire',   1.0},
    {'houndfire',   1.0},
    {'redgem',      0.2},
})
GLOBAL.SetSharedLootTable('hound_cold_new',
{
    {'buttplug_blue', 0.23},
	{'monstermeat', 1.0},
    {'houndstooth', 1.0},
    {'houndstooth', 1.0},
    {'bluegem',     0.2},
})

GLOBAL.SetSharedLootTable('bishop_new',
{
    {'gears',       1.0},
    {'gears',       1.0},
    {'purplegem',   1.0},
	{'vibrator', 0.33},
})

GLOBAL.SetSharedLootTable('knight_new',
{
    {'gears',  1.0},
    {'gears',  1.0},
	{'vibrator', 0.33},
})

GLOBAL.SetSharedLootTable('rook_new',
{
    {'gears',  1.0},
    {'gears',  1.0},
	{'vibrator', 0.33},
})

AddPrefabPostInit("firehound", function(inst) 
    if not GLOBAL.TheWorld.ismastersim then
        return inst
    end
    inst.components.lootdropper:SetChanceLootTable('hound_fire_new')
end)
AddPrefabPostInit("icehound", function(inst) 
    if not GLOBAL.TheWorld.ismastersim then
        return inst
    end
    inst.components.lootdropper:SetChanceLootTable('hound_cold_new')
end)
AddPrefabPostInit("bishop", function(inst) 
    if not GLOBAL.TheWorld.ismastersim then
        return inst
    end
    inst.components.lootdropper:SetChanceLootTable('bishop_new')
end)
AddPrefabPostInit("knight", function(inst) 
    if not GLOBAL.TheWorld.ismastersim then
        return inst
    end
    inst.components.lootdropper:SetChanceLootTable('knight_new')
end)
AddPrefabPostInit("rook", function(inst) 
    if not GLOBAL.TheWorld.ismastersim then
        return inst
    end
    inst.components.lootdropper:SetChanceLootTable('rook_new')
end)

AddPrefabPostInit("oceanfishingbobber_oval", function(inst) 
    inst:AddTag("plug")
    if not GLOBAL.TheWorld.ismastersim then
        return inst
    end
	
    inst:AddComponent("equippable")
    inst.components.equippable.equipslot = GLOBAL.EQUIPSLOTS.BODY
end)

AddPrefabPostInit("oceanfishingbobber_ball", function(inst) 
    inst:AddTag("plug")
	if not GLOBAL.TheWorld.ismastersim then
        return inst
    end
	
    inst:AddComponent("equippable")
    inst.components.equippable.equipslot = GLOBAL.EQUIPSLOTS.BODY
end)



GLOBAL.Censore = function(player,x,y,sym,sx,sy,sz)
    -- local cen = GLOBAL.SpawnPrefab("censor")
	-- player:DoTaskInTime(0, function()
	    -- cen.Transform:SetScale(sx,sy,sz)
		-- cen.pin_x = x
		-- cen.pin_y = y
		-- cen.pin_sym = sym
		-- cen.owner = player
		-- cen:PushEvent("Pin")
	-- end)	
end

GLOBAL.RemoveCensore = function(player)
    -- if player.censors then
	    -- for x = 1,#player.censors,1 do
		    -- player.censors[x]:Remove()
		-- end
    -- end	
end

-- RemoveCensore(ThePlayer)

-- Censore(ThePlayer,0,0,"torso",1,0.2,0.5)	- Pussy
-- Censore(ThePlayer,0,-58,"torso",0.5,0.2,0.5)	- Tits

--ThePlayer.AnimState:OverrideSymbol("swap_body_tall", "white_dick", "swap_body_tall")
--ThePlayer.AnimState:OverrideSymbol("swap_body", "chaintits", "swap_body")
--ThePlayer.AnimState:OverrideSymbol("tail", "plug_foxtail", "tail")
--ThePlayer.AnimState:SetDeltaTimeMultiplier(3)
--ThePlayer.AnimState:GetCurrentFacing()
--ThePlayer.components.cumattachable:AddCum() TUNING.CUM_X
--ThePlayer.AnimState:OverrideSymbol("torso", "large_nude_hd", "torso")
--printwrap("", getmetatable(ThePlayer.AnimState).__index)